<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covey's Time Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .todo-item-deadline {
            font-size: 0.8em;
            color: #666;
        }

        .todo-item.overdue .todo-item-deadline {
            color: #f00;
        }
    </style>
</head>

<body>
    <header>
        <h1>Covey's Time Management</h1>
        <h3>A simple time management app</h3>
    </header>
    <main id="app">
        <!-- The app will be rendered here -->
    </main>

    <dialog id="todoDialog">
        <form id="todoForm">
            <h2 id="dialogTitle">Add Todo</h2>
            <div class="form-group">
                <label for="todoText">Todo:</label>
                <input type="text" id="todoText" name="todoText" required>
            </div>
            <div class="form-group">
                <label for="todoType">Type:</label>
                <select id="todoType" name="todoType">
                    <option value="imp-urg">Important & Urgent</option>
                    <option value="imp-nurg">Important & Not Urgent</option>
                    <option value="nimp-urg">Not Important & Urgent</option>
                    <option value="nimp-nurg">Not Important & Not Urgent</option>
                </select>
            </div>
            <div class="form-group">
                <label for="todoDeadline">Deadline:</label>
                <input type="datetime-local" id="todoDeadline" name="todoDeadline">
            </div>
            <div class="form-actions">
                <button type="submit">Save</button>
                <button type="button" id="cancelButton">Cancel</button>
            </div>
        </form>
    </dialog>

    <script>
        // State
        let state = {
            todos: [],
            nextId: 1,
            editingTodoId: null
        };

        // Load data from local storage
        function loadFromLocalStorage() {
            const savedState = localStorage.getItem('coveyTimeManagementState');
            if (savedState) {
                state = JSON.parse(savedState);
            } else {
                // If no saved state, initialize with an example todo
                state.todos.push({
                    id: state.nextId++,
                    text: "Example todo",
                    type: "imp-urg",
                    done: false,
                    deadline: new Date(Date.now() + 86400000).toISOString()
                });
            }
        }

        // Save data to local storage
        function saveToLocalStorage() {
            localStorage.setItem('coveyTimeManagementState', JSON.stringify(state));
        }

        // Actions
        function addTodo(text, type, deadline) {
            state.todos.push({ id: state.nextId++, text, type, done: false, deadline });
            saveToLocalStorage();
            render();
        }

        function deleteTodo(id) {
            state.todos = state.todos.filter(todo => todo.id !== id);
            saveToLocalStorage();
            render();
        }

        function toggleTodo(id) {
            const todo = state.todos.find(todo => todo.id === id);
            if (todo) todo.done = !todo.done;
            saveToLocalStorage();
            render();
        }

        function moveTodo(id, newType) {
            const todo = state.todos.find(todo => todo.id === id);
            if (todo && todo.type !== newType) {
                todo.type = newType;
                saveToLocalStorage();
                render();
            }
        }

        function editTodo(id, newText, newType, newDeadline) {
            const todo = state.todos.find(todo => todo.id === id);
            if (todo) {
                todo.text = newText;
                todo.type = newType;
                todo.deadline = newDeadline;
            }
            saveToLocalStorage();
            render();
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="grid-container">
                    <div class="imp-text font-lg">Important</div>
                    <div class="nimp-text font-lg">Not Important</div>
                    <div class="urg-text font-lg">Urgent</div>
                    <div class="nurg-text font-lg">Not Urgent</div>
                    ${renderQuadrant('imp-urg', 'Do First')}
                    ${renderQuadrant('imp-nurg', 'Schedule')}
                    ${renderQuadrant('nimp-urg', 'Delegate')}
                    ${renderQuadrant('nimp-nurg', 'Don\'t Do')}
                </div>
            `;
            addEventListeners();
        }

        function renderQuadrant(type, title) {
            const todos = state.todos.filter(todo => todo.type === type);
            return `
                <div class="grid-items ${type}" data-type="${type}">
                    <button class="add-button flex-center" data-type="${type}">+</button>
                    <div class="grid-item-title">${title}</div>
                    <div class="todo-container">
                        ${todos.map(todo => renderTodoItem(todo)).join('')}
                    </div>
                </div>
            `;
        }

        function renderTodoItem(todo) {
            const deadlineDate = todo.deadline ? new Date(todo.deadline) : null;
            const isOverdue = deadlineDate ? deadlineDate < new Date() && !todo.done : false;
            return `
                <div class="todo-item ${todo.done ? 'done' : ''} ${isOverdue ? 'overdue' : ''}" draggable="true" data-id="${todo.id}">
                    <div class="todo-item-text">
                        ${todo.text}
                        <div class="todo-item-deadline">
                            Deadline: ${deadlineDate ?
                    deadlineDate.toLocaleString() : "No deadline"}
                        </div>
                        <button class="delete-button" data-id="${todo.id}">X</button>
                        <button class="done-button" data-id="${todo.id}">✓</button>
                        <button class="edit-button" data-id="${todo.id}">✎</button>
                    </div>
                </div>
            `;
        }

        // Event Listeners
        function addEventListeners() {
            document.querySelectorAll('.add-button').forEach(button => {
                button.addEventListener('click', openAddDialog);
            });

            document.querySelectorAll('.todo-item').forEach(item => {
                item.addEventListener('dragstart', drag);
            });

            document.querySelectorAll('.grid-items').forEach(item => {
                item.addEventListener('dragover', allowDrop);
                item.addEventListener('drop', drop);
            });

            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', (e) => deleteTodo(parseInt(e.target.dataset.id)));
            });

            document.querySelectorAll('.done-button').forEach(button => {
                button.addEventListener('click', (e) => toggleTodo(parseInt(e.target.dataset.id)));
            });

            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', (e) => openEditDialog(parseInt(e.target.dataset.id)));
            });
        }

        function openAddDialog(e) {
            const dialog = document.getElementById('todoDialog');
            const form = document.getElementById('todoForm');
            const todoType = document.getElementById('todoType');
            const dialogTitle = document.getElementById('dialogTitle');
            dialogTitle.textContent = 'Add Todo';
            form.reset();
            todoType.value = e.target.dataset.type;
            state.editingTodoId = null;
            dialog.showModal();
        }

        function openEditDialog(id) {
            const dialog = document.getElementById('todoDialog');
            const form = document.getElementById('todoForm');
            const todoText = document.getElementById('todoText');
            const todoType = document.getElementById('todoType');
            const todoDeadline = document.getElementById('todoDeadline');
            const dialogTitle = document.getElementById('dialogTitle');

            const todo = state.todos.find(todo => todo.id === id);
            if (todo) {
                dialogTitle.textContent = 'Edit Todo';
                todoText.value = todo.text;
                todoType.value = todo.type;
                todoDeadline.value = todo.deadline.slice(0, 16);
                state.editingTodoId = id;
                dialog.showModal();
            }
        }

        document.getElementById('todoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const todoText = document.getElementById('todoText');
            const todoType = document.getElementById('todoType');
            const todoDeadline = document.getElementById('todoDeadline');

            if (state.editingTodoId === null) {
                addTodo(todoText.value, todoType.value, todoDeadline.value);
            } else {
                editTodo(state.editingTodoId, todoText.value, todoType.value, todoDeadline.value);
                state.editingTodoId = null;
            }

            document.getElementById('todoDialog').close();
        });

        document.getElementById('cancelButton').addEventListener('click', () => {
            document.getElementById('todoDialog').close();
        });

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.id);
        }

        function drop(ev) {
            ev.preventDefault();
            const todoId = parseInt(ev.dataTransfer.getData("text"));
            const newType = ev.target.closest('.grid-items').dataset.type;
            moveTodo(todoId, newType);
        }

        // Load data and initial render
        loadFromLocalStorage();
        render();
    </script>
</body>

</html>